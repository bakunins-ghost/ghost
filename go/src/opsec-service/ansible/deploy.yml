---
- name: Deploy the server
  hosts: webservers
  become: yes # Use sudo on the remote host (necessary for systemctl restart)

  tasks:
    - name: Stop the system-mgr service
      ansible.builtin.systemd:
        name: system-mgr.service
        state: stopped
      # This prevents the "Address already in use" conflict during copy

    - name: Copy new binary to deployment path
      ansible.builtin.copy:
        src: ../system-mgr  # Source file from the GitHub Actions artifact
        dest: /home/ghost/go/src/opsec-service/system-mgr
        owner: ghost
        group: ghost
        mode: '0755' # Ensure executable permissions
      # This task needs the artifact from GitHub Actions downloaded locally first

    - name: Restart the system-mgr service
      ansible.builtin.systemd:
        name: system-mgr.service
        state: restarted
      # This launches the service using the newly copied binary

    - name: Verify service status
      ansible.builtin.systemd:
        name: system-mgr.service
        state: started
      register: service_status
      # Verify service started successfully

    - name: Show service status
      ansible.builtin.debug:
        msg: "Service Active: {{ service_status.status.ActiveState }}"